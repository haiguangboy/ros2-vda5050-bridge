# ä¸­åŠ›åè®®æ¡¥æ¥å™¨MQTTé€šä¿¡åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†ä¸­åŠ›å…·èº«æœºå™¨äººROS2-VDA5050æ¡¥æ¥å™¨çš„ä¸‰ä¸ªæ ¸å¿ƒMQTTé€šä¿¡åŠŸèƒ½çš„å®ç°æ–¹æ¡ˆã€æµ‹è¯•æ–¹æ³•å’Œæµ‹è¯•ç»“æœã€‚

## æµ‹è¯•ç¯å¢ƒ

- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04 LTS
- **ROS2ç‰ˆæœ¬**: Humble
- **MQTT Broker**: Mosquitto (localhost:1883)
- **ç¼–ç¨‹è¯­è¨€**: C++ (æ¡¥æ¥å™¨) + Python (æµ‹è¯•è„šæœ¬)
- **æœºå™¨äººID**: robot-001

## æ ¸å¿ƒåŠŸèƒ½

### 1. ä»»åŠ¡ä¸‹å‘åŠŸèƒ½ (è°ƒåº¦ç³»ç»Ÿ â†’ æœºå™¨äºº)

**åŠŸèƒ½æè¿°**: è°ƒåº¦ç³»ç»Ÿé€šè¿‡MQTTå‘æœºå™¨äººä¸‹å‘ä»»åŠ¡æŒ‡ä»¤

**MQTTä¸»é¢˜**: `EP/master/{robotId}/task`

**æ¶ˆæ¯æ ¼å¼** (ä¸­åŠ›åè®®æ ‡å‡†):
```json
{
  "timestamp": "2025-09-18T04:46:33.785Z",
  "taskId": "task-robot-001-20250918-124340-000",
  "startArea": "AREA-1",
  "startAction": "ground_pick",
  "targetArea": "STORAGE-1",
  "targetAction": "ground_place"
}
```

**æ”¯æŒçš„åŠ¨ä½œç±»å‹**:
- `ground_pick`: åœ°é¢å–è´§
- `ground_place`: åœ°é¢æ”¾è´§
- `load`: è£…è½½è´§ç‰©
- `unload`: å¸è½½è´§ç‰©

### 2. è®¾å¤‡çŠ¶æ€ä¸ŠæŠ¥åŠŸèƒ½ (æœºå™¨äºº â†’ è°ƒåº¦ç³»ç»Ÿ)

**åŠŸèƒ½æè¿°**: æœºå™¨äººå®æ—¶å‘è°ƒåº¦ç³»ç»Ÿä¸ŠæŠ¥è®¾å¤‡çŠ¶æ€ä¿¡æ¯

**MQTTä¸»é¢˜**: `EP/master/{robotId}/state`

**å‘å¸ƒé¢‘ç‡**: 2Hz (æ¯0.5ç§’)

**æ¶ˆæ¯å†…å®¹**:
```json
{
  "timestamp": "2025-09-18T04:46:33.785Z",
  "systemState": "running",
  "pose": {
    "x": 0.00,
    "y": 0.00,
    "theta": 0.00
  },
  "forkliftState": {
    "height": 0.00,
    "weight": 0.0,
    "lateralShift": 0.00,
    "forwardExtension": 0.00,
    "tiltBack": false,
    "status": "ready"
  },
  "battery": {
    "percentage": 85.5,
    "voltage": 24.2,
    "current": 2.1,
    "temperature": 25.3,
    "status": "normal"
  },
  "errors": []
}
```

### 3. ä»»åŠ¡çŠ¶æ€ä¸ŠæŠ¥åŠŸèƒ½ (æœºå™¨äºº â†’ è°ƒåº¦ç³»ç»Ÿ)

**åŠŸèƒ½æè¿°**: æœºå™¨äººå‘è°ƒåº¦ç³»ç»Ÿä¸ŠæŠ¥ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€

**MQTTä¸»é¢˜**: `EP/master/{robotId}/task_status`

**æ¶ˆæ¯æ ¼å¼**:
```json
{
  "timestamp": "2025-09-18T04:46:35.000Z",
  "taskId": "task-robot-001-20250918-124340-000",
  "status": "success",
  "finishTime": "2025-09-18T04:46:35.000Z",
  "reason": ""
}
```

**çŠ¶æ€ç±»å‹**:
- `success`: ä»»åŠ¡æˆåŠŸå®Œæˆ
- `failed`: ä»»åŠ¡æ‰§è¡Œå¤±è´¥

## æµ‹è¯•è„šæœ¬

### 1. ä»»åŠ¡ä¸‹å‘æµ‹è¯•è„šæœ¬

**æ–‡ä»¶**: `tests/scripts/test_mqtt_task_sender.py`

**åŠŸèƒ½**: æ¨¡æ‹Ÿè°ƒåº¦ç³»ç»Ÿå‘æ¡¥æ¥å™¨å‘é€ä»»åŠ¡æŒ‡ä»¤

**ä½¿ç”¨æ–¹æ³•**:
```bash
cd tests/scripts
python3 test_mqtt_task_sender.py
```

**æµ‹è¯•å†…å®¹**:
- å¾ªç¯å‘é€ä¸‰ç§ç±»å‹çš„ä»»åŠ¡: ground_pick, load, ground_place
- æ¯5ç§’å‘é€ä¸€ä¸ªä»»åŠ¡
- è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„ä»»åŠ¡ID
- æ¨¡æ‹Ÿä¸åŒçš„èµ·å§‹åŒºåŸŸå’Œç›®æ ‡åŒºåŸŸ

**é¢„æœŸè¾“å‡º**:
```
ğŸ“‹ å¯åŠ¨MQTTä»»åŠ¡ä¸‹å‘æµ‹è¯•
âœ… å·²è¿æ¥åˆ°MQTT Broker: localhost:1883
ğŸ“¤ å°†å‘ä¸»é¢˜å‘é€ä»»åŠ¡: EP/master/robot-001/task

ğŸ“‹ å‘é€ä»»åŠ¡ #0 - ç±»å‹: ground_pick
   ä»»åŠ¡ID: task-robot-001-20250918-124340-000
   èµ·å§‹åŒºåŸŸ: AREA-1 (åŠ¨ä½œ: ground_pick)
   ç›®æ ‡åŒºåŸŸ: STORAGE-1 (åŠ¨ä½œ: ground_place)
âœ… ä»»åŠ¡æ¶ˆæ¯å‘é€æˆåŠŸ
```

### 2. è®¾å¤‡çŠ¶æ€ç›‘æ§æµ‹è¯•è„šæœ¬

**æ–‡ä»¶**: `tests/scripts/test_device_state_monitor.py`

**åŠŸèƒ½**: ç›‘å¬æ¡¥æ¥å™¨å‘å¸ƒçš„è®¾å¤‡çŠ¶æ€æ¶ˆæ¯

**ä½¿ç”¨æ–¹æ³•**:
```bash
cd tests/scripts
python3 test_device_state_monitor.py
```

**æµ‹è¯•å†…å®¹**:
- è®¢é˜…è®¾å¤‡çŠ¶æ€ä¸»é¢˜
- å®æ—¶æ˜¾ç¤ºæ¥æ”¶åˆ°çš„çŠ¶æ€ä¿¡æ¯
- è§£æå¹¶æ ¼å¼åŒ–æ˜¾ç¤ºä½å§¿ã€è´§å‰ã€ç”µæ± ç­‰çŠ¶æ€
- è®¡ç®—æ¶ˆæ¯æ¥æ”¶é—´éš”

**é¢„æœŸè¾“å‡º**:
```
ğŸ“Š å¯åŠ¨MQTTè®¾å¤‡çŠ¶æ€ç›‘æ§æµ‹è¯•
âœ… å·²è¿æ¥åˆ°MQTT Broker: localhost:1883
âœ… æˆåŠŸè®¢é˜…ä¸»é¢˜: EP/master/robot-001/state

ğŸ“Š æ”¶åˆ°è®¾å¤‡çŠ¶æ€æ¶ˆæ¯ #1
   ä¸»é¢˜: EP/master/robot-001/state
   æ—¶é—´: 2025-09-18 12:46:33
   åŸºæœ¬ä¿¡æ¯:
     - æ—¶é—´æˆ³: 2025-09-18T04:46:33.785Z
     - ç³»ç»ŸçŠ¶æ€: running
   ä½å§¿ä¿¡æ¯:
     - ä½ç½®: x=0.00, y=0.00
     - è§’åº¦: Î¸=0.00Â°
   è´§å‰çŠ¶æ€:
     - é«˜åº¦: 0.00m
     - è´Ÿè½½: 0.0kg
     - çŠ¶æ€: ready
```

### 3. ä»»åŠ¡çŠ¶æ€ç›‘æ§æµ‹è¯•è„šæœ¬

**æ–‡ä»¶**: `tests/scripts/test_task_status_monitor.py`

**åŠŸèƒ½**: ç›‘å¬æ¡¥æ¥å™¨å‘å¸ƒçš„ä»»åŠ¡çŠ¶æ€æ¶ˆæ¯

**ä½¿ç”¨æ–¹æ³•**:
```bash
cd tests/scripts
python3 test_task_status_monitor.py
```

**æµ‹è¯•å†…å®¹**:
- è®¢é˜…ä»»åŠ¡çŠ¶æ€ä¸»é¢˜
- ç­‰å¾…å¹¶æ˜¾ç¤ºä»»åŠ¡å®ŒæˆçŠ¶æ€æ¶ˆæ¯
- è§£æä»»åŠ¡æ‰§è¡Œç»“æœå’Œå¤±è´¥åŸå› 

## å®Œæ•´æµ‹è¯•æµç¨‹

### 1. å¯åŠ¨æ¡¥æ¥å™¨

```bash
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd /home/yhg/Documents/docs/zhongli/cpp_version

# ç¼–è¯‘é¡¹ç›®
cd scripts/build
./build_and_test.sh

# å¯åŠ¨æ¡¥æ¥å™¨
cd ../..
./install/bin/zhongli_bridge_node --ros-args --params-file config/bridge_config.yaml
```

**é¢„æœŸè¾“å‡º**:
```
ğŸš€ ä¸­åŠ›å…·èº«æœºå™¨äººROS2æ¡¥æ¥å™¨ - C++ç‰ˆæœ¬
âœ… MQTTè¿æ¥å»ºç«‹æˆåŠŸ
âœ… å·²è¿æ¥åˆ°EMQXæœåŠ¡å™¨
ğŸ“ å·²è®¢é˜…ä¸»é¢˜: EP/master/robot-001/task
ğŸ¯ æ¡¥æ¥å™¨å¯åŠ¨æˆåŠŸï¼Œæ­£åœ¨è¿è¡Œ...
```

### 2. æµ‹è¯•ä»»åŠ¡ä¸‹å‘ (ç»ˆç«¯1)

```bash
cd tests/scripts
python3 test_mqtt_task_sender.py
```

åœ¨æ¡¥æ¥å™¨ç»ˆç«¯åº”è¯¥çœ‹åˆ°:
```
ğŸ“© æ”¶åˆ°MQTTæ¶ˆæ¯ - ä¸»é¢˜: EP/master/robot-001/task
[INFO] ğŸ“‹ æ”¶åˆ°ä»»åŠ¡: task-robot-001-20250918-124340-000
```

### 3. æµ‹è¯•è®¾å¤‡çŠ¶æ€ç›‘æ§ (ç»ˆç«¯2)

```bash
cd tests/scripts
python3 test_device_state_monitor.py
```

åº”è¯¥æ¯0.5ç§’æ¥æ”¶åˆ°è®¾å¤‡çŠ¶æ€æ¶ˆæ¯ã€‚

### 4. æµ‹è¯•ä»»åŠ¡çŠ¶æ€ç›‘æ§ (ç»ˆç«¯3)

```bash
cd tests/scripts
python3 test_task_status_monitor.py
```

å½“æœ‰ä»»åŠ¡å®Œæˆæ—¶ä¼šæ¥æ”¶åˆ°çŠ¶æ€æ¶ˆæ¯ã€‚

## æµ‹è¯•ç»“æœ

### âœ… ä»»åŠ¡ä¸‹å‘æµ‹è¯•ç»“æœ

- **çŠ¶æ€**: æˆåŠŸ
- **éªŒè¯**: æ¡¥æ¥å™¨èƒ½å¤Ÿæ­£ç¡®æ¥æ”¶å¹¶è§£æè°ƒåº¦ç³»ç»Ÿå‘é€çš„ä»»åŠ¡æŒ‡ä»¤
- **æ—¥å¿—ç¤ºä¾‹**:
  ```
  ğŸ“© æ”¶åˆ°MQTTæ¶ˆæ¯ - ä¸»é¢˜: EP/master/robot-001/task
  [INFO] [1758170620.984296303] [zhongli_bridge]: ğŸ“‹ æ”¶åˆ°ä»»åŠ¡: task-robot-001-20250918-124340-000
  ```

### âœ… è®¾å¤‡çŠ¶æ€ä¸ŠæŠ¥æµ‹è¯•ç»“æœ

- **çŠ¶æ€**: æˆåŠŸ
- **é¢‘ç‡**: 2Hz (æ¯0.5ç§’å‘å¸ƒä¸€æ¬¡)
- **æ•°æ®å®Œæ•´æ€§**: æ‰€æœ‰çŠ¶æ€å­—æ®µå‡æ­£å¸¸
- **æ¶ˆæ¯ç¤ºä¾‹**: åŒ…å«å®Œæ•´çš„ä½å§¿ã€è´§å‰ã€ç”µæ± çŠ¶æ€ä¿¡æ¯

### âœ… ä»»åŠ¡çŠ¶æ€ä¸ŠæŠ¥æµ‹è¯•ç»“æœ

- **çŠ¶æ€**: å·¥å…·å°±ç»ª
- **åŠŸèƒ½**: ç›‘æ§è„šæœ¬å·²åˆ›å»ºï¼Œå¯ç›‘å¬ä»»åŠ¡å®ŒæˆçŠ¶æ€
- **è§¦å‘æ¡ä»¶**: å½“æ¡¥æ¥å™¨å®Œæˆä»»åŠ¡æ—¶è‡ªåŠ¨å‘å¸ƒçŠ¶æ€æ¶ˆæ¯

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è™šæ‹ŸMQTTæ¨¡å¼**
   - ç—‡çŠ¶: æ¡¥æ¥å™¨æ˜¾ç¤º "âš ï¸ ä½¿ç”¨è™šæ‹ŸMQTTå®¢æˆ·ç«¯"
   - è§£å†³: é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼Œç¡®ä¿mosquittoåº“æ­£ç¡®é“¾æ¥
   ```bash
   cd scripts/build
   ./build_and_test.sh
   ```

2. **JSONè§£æå¤±è´¥**
   - ç—‡çŠ¶: "âŒ è§£æMQTTæ¶ˆæ¯å¤±è´¥: key 'startArea' not found"
   - è§£å†³: ç¡®ä¿æµ‹è¯•è„šæœ¬ä½¿ç”¨æ­£ç¡®çš„ä¸­åŠ›åè®®æ¶ˆæ¯æ ¼å¼

3. **MQTTè¿æ¥å¤±è´¥**
   - ç—‡çŠ¶: "âŒ MQTTè¿æ¥å¤±è´¥"
   - è§£å†³: æ£€æŸ¥mosquittoæœåŠ¡çŠ¶æ€
   ```bash
   sudo systemctl status mosquitto
   sudo systemctl start mosquitto  # å¦‚æœæœªå¯åŠ¨
   ```

### ä¾èµ–æ£€æŸ¥

ç¡®ä¿ä»¥ä¸‹ä¾èµ–å·²å®‰è£…:
```bash
# æ£€æŸ¥mosquitto
dpkg -l | grep mosquitto

# æ£€æŸ¥Python MQTTåº“
pip3 list | grep paho-mqtt
```

### å®‰è£…ç¼ºå¤±ä¾èµ–

å¦‚æœæµ‹è¯•è„šæœ¬æŠ¥é”™ `ModuleNotFoundError: No module named 'paho'`ï¼Œè¯·å®‰è£…Python MQTTåº“:

```bash
# å®‰è£…Python MQTTå®¢æˆ·ç«¯åº“
pip3 install paho-mqtt

# æˆ–è€…ä½¿ç”¨aptå®‰è£…ï¼ˆæ¨èï¼‰
sudo apt update
sudo apt install python3-paho-mqtt

# éªŒè¯å®‰è£…
python3 -c "import paho.mqtt.client; print('paho-mqtt installed successfully')"
```

**æ³¨æ„**: åœ¨ARM64å¹³å°ï¼ˆå¦‚Jetsonç­‰ï¼‰ä¸Šï¼Œæ¨èä½¿ç”¨aptå®‰è£…ï¼Œé¿å…ç¼–è¯‘é—®é¢˜ã€‚

## æŠ€æœ¯å®ç°è¦ç‚¹

### 1. MQTTåº“é›†æˆ

æ¡¥æ¥å™¨ä½¿ç”¨mosquitto C++åº“è¿›è¡ŒMQTTé€šä¿¡:
- **CMakeæ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿä¸­çš„mosquittoåº“
- **å›é€€æœºåˆ¶**: å¦‚æœæ‰¾ä¸åˆ°åº“åˆ™ä½¿ç”¨è™šæ‹Ÿå®ç°ç”¨äºç¼–è¯‘
- **ä¸»é¢˜ç®¡ç†**: è‡ªåŠ¨æ„å»ºç¬¦åˆä¸­åŠ›åè®®çš„ä¸»é¢˜åç§°

### 2. æ¶ˆæ¯åºåˆ—åŒ–

ä½¿ç”¨nlohmann/jsonåº“è¿›è¡ŒJSONåºåˆ—åŒ–:
- **ç±»å‹å®‰å…¨**: å¼ºç±»å‹çš„C++ç»“æ„ä½“å®šä¹‰
- **è‡ªåŠ¨åºåˆ—åŒ–**: æ¯ä¸ªæ¶ˆæ¯ç±»å‹éƒ½æœ‰to_json()æ–¹æ³•
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„JSONè§£æé”™è¯¯å¤„ç†

### 3. å¼‚æ­¥é€šä¿¡

- **éé˜»å¡**: MQTTé€šä¿¡ä¸é˜»å¡ROS2ä¸»å¾ªç¯
- **å›è°ƒæœºåˆ¶**: ä½¿ç”¨å›è°ƒå‡½æ•°å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
- **çº¿ç¨‹å®‰å…¨**: ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®å®‰å…¨

## é…ç½®è¯´æ˜

### æ¡¥æ¥å™¨é…ç½® (config/bridge_config.yaml)

```yaml
zhongli_bridge:
  ros__parameters:
    robot_id: "robot-001"
    mqtt_broker_host: "localhost"
    mqtt_broker_port: 1883
    state_publish_rate: 2.0  # è®¾å¤‡çŠ¶æ€å‘å¸ƒé¢‘ç‡
```

### ä¸»è¦å‚æ•°

- **robot_id**: æœºå™¨äººå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºæ„å»ºMQTTä¸»é¢˜
- **mqtt_broker_host**: MQTTä»£ç†æœåŠ¡å™¨åœ°å€
- **mqtt_broker_port**: MQTTä»£ç†æœåŠ¡å™¨ç«¯å£
- **state_publish_rate**: è®¾å¤‡çŠ¶æ€å‘å¸ƒé¢‘ç‡(Hz)

## æ‰©å±•æµ‹è¯•

### æ·»åŠ æ–°çš„æµ‹è¯•åœºæ™¯

1. **åˆ›å»ºæ–°çš„æµ‹è¯•è„šæœ¬**:
   ```python
   # tests/scripts/test_custom_scenario.py
   # å‚è€ƒç°æœ‰è„šæœ¬æ ¼å¼
   ```

2. **ä¿®æ”¹æ¶ˆæ¯æ ¼å¼**:
   - å‚è€ƒ `src/include/zhongli_protocol_types.hpp` ä¸­çš„æ¶ˆæ¯å®šä¹‰
   - ç¡®ä¿JSONå­—æ®µä¸C++ç»“æ„ä½“åŒ¹é…

3. **æ·»åŠ æ–°çš„MQTTä¸»é¢˜**:
   - åœ¨ `src/lib/zhongli_mqtt_client.cpp` ä¸­æ·»åŠ ä¸»é¢˜å®šä¹‰
   - æ›´æ–°ç›¸åº”çš„å‘å¸ƒ/è®¢é˜…é€»è¾‘

---

**æœ€åæ›´æ–°**: 2025-09-18
**æµ‹è¯•çŠ¶æ€**: æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡ âœ…