# ä¸­åŠ›å…·èº«æœºå™¨äººç³»ç»Ÿæ–°åè®®æµ‹è¯•æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†ä¸­åŠ›å…·èº«æœºå™¨äººç³»ç»Ÿæ–°åè®®çš„å®Œæ•´æµ‹è¯•æ–¹æ³•ï¼ŒåŒ…æ‹¬ç¯å¢ƒå‡†å¤‡ã€ä¾èµ–æœåŠ¡å¯åŠ¨ã€æµ‹è¯•æ‰§è¡Œæ­¥éª¤ç­‰ã€‚

## æµ‹è¯•ç¯å¢ƒè¦æ±‚

### ç¡¬ä»¶è¦æ±‚
- Linuxç³»ç»Ÿ (æ¨èUbuntu 20.04+)
- è‡³å°‘4GBå†…å­˜
- ç½‘ç»œè¿æ¥

### è½¯ä»¶ä¾èµ–
```bash
# Pythonä¾èµ–
pip3 install paho-mqtt
pip3 install rospy

# ç³»ç»Ÿä¾èµ–
sudo apt-get update
sudo apt-get install -y python3-pip
```

## æµ‹è¯•æ¶æ„

```
æµ‹è¯•ç¯å¢ƒæ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    MQTT Broker    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµ‹è¯•è„šæœ¬        â”‚  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚  æ¨¡æ‹Ÿæ§åˆ¶å™¨      â”‚
â”‚  (ROS2ç«¯)       â”‚                   â”‚  (è½¦è½½å°è„‘ç«¯)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æµ‹è¯•å‰å‡†å¤‡

### 1. å¯åŠ¨MQTT Broker

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨Dockerå¯åŠ¨ï¼ˆæ¨èï¼‰
```bash
# å¯åŠ¨Eclipse Mosquitto MQTT Broker
docker run -it -p 1883:1883 -p 9001:9001 --name mosquitto eclipse-mosquitto

# æˆ–è€…ä½¿ç”¨docker-compose
cat > docker-compose.yml << EOF
version: '3'
services:
  mosquitto:
    image: eclipse-mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
EOF

docker-compose up -d
```

#### æ–¹å¼äºŒï¼šç›´æ¥å®‰è£…Mosquitto
```bash
# å®‰è£…Mosquitto
sudo apt-get install -y mosquitto mosquitto-clients

# å¯åŠ¨æœåŠ¡
sudo systemctl start mosquitto
sudo systemctl enable mosquitto

# éªŒè¯æœåŠ¡çŠ¶æ€
sudo systemctl status mosquitto
```

### 2. é…ç½®MQTT Broker

åˆ›å»ºé…ç½®æ–‡ä»¶ `mosquitto.conf`:
```conf
listener 1883
allow_anonymous true
persistence true
persistence_location /mosquitto/data/
log_dest file /mosquitto/log/mosquitto.log
```

### 3. éªŒè¯MQTTè¿æ¥

```bash
# æµ‹è¯•MQTTè¿æ¥
mosquitto_pub -h localhost -t "test/topic" -m "Hello MQTT"
mosquitto_sub -h localhost -t "test/topic"

# é¢„æœŸè¾“å‡ºï¼šåœ¨è®¢é˜…ç»ˆç«¯çœ‹åˆ° "Hello MQTT"
```

## æµ‹è¯•é¡¹ç›®

### æµ‹è¯•1ï¼šåŸºç¡€MQTTè¿æ¥æµ‹è¯•

**æ–‡ä»¶**: `test_new_protocol_mqtt.py`

**ç›®çš„**: éªŒè¯MQTTå®¢æˆ·ç«¯è¿æ¥å’ŒåŸºæœ¬é€šä¿¡åŠŸèƒ½

**å¯åŠ¨æœåŠ¡**:
```bash
# ç¡®ä¿MQTT Brokerè¿è¡Œä¸­
docker ps | grep mosquitto
# æˆ–
sudo systemctl status mosquitto
```

**æ‰§è¡Œæµ‹è¯•**:
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/yhg/Documents/docs/zhongli

# è¿è¡ŒåŸºç¡€MQTTæµ‹è¯•
python3 test_new_protocol_mqtt.py
```

**é¢„æœŸç»“æœ**:
```
ğŸ§ª ä¸­åŠ›å…·èº«æœºå™¨äººç³»ç»ŸMQTTå®¢æˆ·ç«¯æµ‹è¯•
============================================================

ğŸ”¬ è¿è¡Œæµ‹è¯•: MQTTè¿æ¥
âœ… MQTTè¿æ¥æµ‹è¯•é€šè¿‡

ğŸ”¬ è¿è¡Œæµ‹è¯•: Topicç»“æ„
âœ… Topicç»“æ„æµ‹è¯•é€šè¿‡

ğŸ”¬ è¿è¡Œæµ‹è¯•: JSONåºåˆ—åŒ–
âœ… JSONåºåˆ—åŒ–æµ‹è¯•é€šè¿‡

ğŸ”¬ è¿è¡Œæµ‹è¯•: æ¶ˆæ¯å‘å¸ƒ
âœ… æ¶ˆæ¯å‘å¸ƒæµ‹è¯•é€šè¿‡

ğŸ”¬ è¿è¡Œæµ‹è¯•: æ¶ˆæ¯æ¥æ”¶
âœ… æ¶ˆæ¯æ¥æ”¶æµ‹è¯•é€šè¿‡

ğŸ“Š æµ‹è¯•æ€»ç»“
==============================
   MQTTè¿æ¥: âœ… é€šè¿‡
   Topicç»“æ„: âœ… é€šè¿‡
   JSONåºåˆ—åŒ–: âœ… é€šè¿‡
   æ¶ˆæ¯å‘å¸ƒ: âœ… é€šè¿‡
   æ¶ˆæ¯æ¥æ”¶: âœ… é€šè¿‡

ğŸ¯ æ€»ä½“ç»“æœ: 5/5 æµ‹è¯•é€šè¿‡
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡! æ–°åè®®MQTTå®¢æˆ·ç«¯åŠŸèƒ½æ­£å¸¸
```

### æµ‹è¯•2ï¼šå®æ—¶çŠ¶æ€åé¦ˆæµ‹è¯•

**æ–‡ä»¶**: `test_realtime_status_feedback.py`

**ç›®çš„**: éªŒè¯æ§åˆ¶å™¨æ‰§è¡Œè¿›åº¦å®æ—¶åé¦ˆåŠŸèƒ½

**å¯åŠ¨æœåŠ¡**:
```bash
# ç¡®ä¿MQTT Brokerè¿è¡Œä¸­ï¼ˆåŒæµ‹è¯•1ï¼‰

# å¦‚æœæµ‹è¯•1é€šè¿‡ï¼Œå¯ä»¥ç»§ç»­æ­¤æµ‹è¯•
# å¦åˆ™å…ˆè§£å†³MQTTè¿æ¥é—®é¢˜
```

**æ‰§è¡Œæµ‹è¯•**:
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/yhg/Documents/docs/zhongli

# è¿è¡Œå®æ—¶çŠ¶æ€åé¦ˆæµ‹è¯•
python3 test_realtime_status_feedback.py
```

**é¢„æœŸç»“æœ**:
```
ğŸ§ª å®æ—¶çŠ¶æ€åé¦ˆç»¼åˆæµ‹è¯•
============================================================

ğŸ”— è¿æ¥MQTTæœåŠ¡å™¨...
âœ… MQTTè¿æ¥æˆåŠŸ

ğŸ“Š æµ‹è¯•1: è½¨è¿¹æ‰§è¡ŒçŠ¶æ€åé¦ˆ
ğŸš€ å¼€å§‹æ¨¡æ‹Ÿè½¨è¿¹æ‰§è¡Œè¿‡ç¨‹...
âœ… è½¨è¿¹çŠ¶æ€åé¦ˆæ­£å¸¸ï¼Œæ”¶åˆ° 7 æ¡çŠ¶æ€æ›´æ–°

ğŸ­ æµ‹è¯•2: åŠ¨ä½œæ‰§è¡ŒçŠ¶æ€åé¦ˆ
ğŸ¬ å¼€å§‹æ¨¡æ‹ŸåŠ¨ä½œæ‰§è¡Œè¿‡ç¨‹...
âœ… åŠ¨ä½œçŠ¶æ€åé¦ˆæ­£å¸¸ï¼Œæ”¶åˆ° 3 æ¡çŠ¶æ€æ›´æ–°

â±ï¸ æµ‹è¯•3: å®æ—¶åé¦ˆå»¶è¿Ÿæ€§èƒ½
ğŸ“Š å»¶è¿Ÿç»Ÿè®¡:
   å¹³å‡å»¶è¿Ÿ: 25.34 ms
   æœ€å¤§å»¶è¿Ÿ: 45.67 ms
   æœ€å°å»¶è¿Ÿ: 12.89 ms
   æˆåŠŸç‡: 5/5 (100%)
   âœ… å»¶è¿Ÿæ€§èƒ½ä¼˜ç§€ (< 50ms)

ğŸ“š æµ‹è¯•4: çŠ¶æ€å†å²è·Ÿè¸ª
ğŸ“Š å†å²è®°å½•ç»Ÿè®¡:
   è½¨è¿¹çŠ¶æ€è®°å½•: 3
   åŠ¨ä½œçŠ¶æ€è®°å½•: 0
   âœ… å†å²è·Ÿè¸ªåŠŸèƒ½æ­£å¸¸

ğŸ“Š æµ‹è¯•æ€»ç»“
==============================
   è½¨è¿¹çŠ¶æ€åé¦ˆ: âœ… é€šè¿‡
   åŠ¨ä½œçŠ¶æ€åé¦ˆ: âœ… é€šè¿‡
   å»¶è¿Ÿæ€§èƒ½: âœ… é€šè¿‡
   å†å²è·Ÿè¸ª: âœ… é€šè¿‡

ğŸ¯ æ€»ä½“ç»“æœ: âœ… é€šè¿‡
ğŸ‰ å®æ—¶çŠ¶æ€åé¦ˆåŠŸèƒ½æµ‹è¯•é€šè¿‡!
```

## è¯¦ç»†æµ‹è¯•æ­¥éª¤

### æ­¥éª¤1ï¼šç¯å¢ƒæ£€æŸ¥

```bash
# 1. æ£€æŸ¥Pythonç‰ˆæœ¬
python3 --version
# è¦æ±‚: Python 3.6+

# 2. æ£€æŸ¥ä¾èµ–åŒ…
python3 -c "import paho.mqtt.client; print('paho-mqtt OK')"
python3 -c "import rospy; print('rospy OK')"

# 3. æ£€æŸ¥ç½‘ç»œè¿æ¥
ping localhost -c 4

# 4. æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 1883
```

### æ­¥éª¤2ï¼šMQTT Brokerå¯åŠ¨éªŒè¯

```bash
# 1. å¯åŠ¨MQTT Broker
docker run -d -p 1883:1883 --name test-mosquitto eclipse-mosquitto

# 2. éªŒè¯å®¹å™¨çŠ¶æ€
docker ps | grep test-mosquitto

# 3. æµ‹è¯•åŸºæœ¬é€šä¿¡
# ç»ˆç«¯1ï¼šå¯åŠ¨è®¢é˜…è€…
mosquitto_sub -h localhost -t "test/connection"

# ç»ˆç«¯2ï¼šå‘å¸ƒæ¶ˆæ¯
mosquitto_pub -h localhost -t "test/connection" -m "connection_test"

# é¢„æœŸï¼šè®¢é˜…è€…ç»ˆç«¯æ”¶åˆ° "connection_test"
```

### æ­¥éª¤3ï¼šè¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

```bash
# åˆ›å»ºæµ‹è¯•è„šæœ¬
cat > run_all_tests.sh << 'EOF'
#!/bin/bash

echo "=========================================="
echo "ä¸­åŠ›å…·èº«æœºå™¨äººç³»ç»Ÿæ–°åè®®æµ‹è¯•"
echo "=========================================="

# æ£€æŸ¥MQTT Broker
echo "æ£€æŸ¥MQTT BrokerçŠ¶æ€..."
if ! pgrep mosquitto > /dev/null && ! docker ps | grep -q mosquitto; then
    echo "å¯åŠ¨MQTT Broker..."
    docker run -d -p 1883:1883 --name test-mosquitto eclipse-mosquitto
    sleep 3
fi

echo "è¿è¡Œæµ‹è¯•1: åŸºç¡€MQTTåŠŸèƒ½"
python3 test_new_protocol_mqtt.py
TEST1_RESULT=$?

echo ""
echo "è¿è¡Œæµ‹è¯•2: å®æ—¶çŠ¶æ€åé¦ˆ"
python3 test_realtime_status_feedback.py
TEST2_RESULT=$?

echo ""
echo "=========================================="
echo "æµ‹è¯•ç»“æœæ±‡æ€»:"
echo "æµ‹è¯•1 (åŸºç¡€MQTT): $([ $TEST1_RESULT -eq 0 ] && echo 'âœ… é€šè¿‡' || echo 'âŒ å¤±è´¥')"
echo "æµ‹è¯•2 (å®æ—¶åé¦ˆ): $([ $TEST2_RESULT -eq 0 ] && echo 'âœ… é€šè¿‡' || echo 'âŒ å¤±è´¥')"

if [ $TEST1_RESULT -eq 0 ] && [ $TEST2_RESULT -eq 0 ]; then
    echo ""
    echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ–°åè®®åŠŸèƒ½æ­£å¸¸ã€‚"
    exit 0
else
    echo ""
    echo "âš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚"
    exit 1
fi
EOF

chmod +x run_all_tests.sh

# æ‰§è¡Œæµ‹è¯•
./run_all_tests.sh
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜1ï¼šMQTTè¿æ¥å¤±è´¥

**ç°è±¡**ï¼š
```
âŒ MQTTè¿æ¥å¤±è´¥
âŒ MQTTè¿æ¥å¼‚å¸¸: Connection refused
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥MQTTæœåŠ¡çŠ¶æ€
sudo systemctl status mosquitto

# é‡å¯æœåŠ¡
sudo systemctl restart mosquitto

# æˆ–ä½¿ç”¨Dockeræ–¹å¼
docker stop test-mosquitto
docker rm test-mosquitto
docker run -d -p 1883:1883 --name test-mosquitto eclipse-mosquitto
```

### å¸¸è§é—®é¢˜2ï¼šPythonä¾èµ–ç¼ºå¤±

**ç°è±¡**ï¼š
```
ModuleNotFoundError: No module named 'paho.mqtt.client'
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
pip3 install paho-mqtt
```

### å¸¸è§é—®é¢˜3ï¼šç«¯å£å ç”¨

**ç°è±¡**ï¼š
```
Error: Address already in use
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tlnp | grep 1883

# åœæ­¢å ç”¨è¿›ç¨‹
sudo kill -9 <PID>

# æˆ–ä¿®æ”¹ç«¯å£
docker run -d -p 1884:1883 --name test-mosquitto eclipse-mosquitto
```

## æµ‹è¯•éªŒè¯æ¸…å•

### MQTTè¿æ¥éªŒè¯
- [ ] MQTT BrokeræˆåŠŸå¯åŠ¨
- [ ] å®¢æˆ·ç«¯èƒ½å¤Ÿè¿æ¥
- [ ] æ¶ˆæ¯å‘å¸ƒæˆåŠŸ
- [ ] æ¶ˆæ¯æ¥æ”¶æˆåŠŸ
- [ ] Topicç»“æ„æ­£ç¡®

### åè®®åŠŸèƒ½éªŒè¯
- [ ] è½¨è¿¹æ¶ˆæ¯åºåˆ—åŒ–/ååºåˆ—åŒ–
- [ ] åŠ¨ä½œæ¶ˆæ¯åºåˆ—åŒ–/ååºåˆ—åŒ–
- [ ] è®¾å¤‡çŠ¶æ€æ¶ˆæ¯åºåˆ—åŒ–/ååºåˆ—åŒ–
- [ ] JSONæ ¼å¼æ­£ç¡®æ€§

### å®æ—¶åé¦ˆéªŒè¯
- [ ] è½¨è¿¹çŠ¶æ€åé¦ˆåŠæ—¶æ€§
- [ ] åŠ¨ä½œçŠ¶æ€åé¦ˆåŠæ—¶æ€§
- [ ] å»¶è¿Ÿ < 100ms
- [ ] çŠ¶æ€å†å²å®Œæ•´

## æ€§èƒ½åŸºå‡†

### å»¶è¿Ÿè¦æ±‚
- **ä¼˜ç§€**: < 50ms
- **è‰¯å¥½**: < 100ms
- **ä¸€èˆ¬**: < 200ms
- **è¾ƒå·®**: > 200ms

### å¯é æ€§è¦æ±‚
- **è¿æ¥æˆåŠŸç‡**: > 95%
- **æ¶ˆæ¯æŠ•é€’ç‡**: > 99%
- **é”™è¯¯æ¢å¤æ—¶é—´**: < 5s

## æ—¥å¿—åˆ†æ

### æŸ¥çœ‹æµ‹è¯•æ—¥å¿—
```bash
# æŸ¥çœ‹MQTT Brokeræ—¥å¿—
docker logs test-mosquitto

# æˆ–æŸ¥çœ‹ç³»ç»ŸæœåŠ¡æ—¥å¿—
sudo journalctl -u mosquitto -f
```

### è°ƒè¯•æ¨¡å¼
```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
export MQTT_LOG_LEVEL=DEBUG
python3 test_new_protocol_mqtt.py
```

## æ€»ç»“

æœ¬æµ‹è¯•æŒ‡å—æä¾›äº†å®Œæ•´çš„æ–°åè®®æµ‹è¯•æ–¹æ³•ï¼ŒåŒ…æ‹¬ï¼š
1. ç¯å¢ƒå‡†å¤‡å’Œä¾èµ–å®‰è£…
2. MQTT Brokeré…ç½®å’Œå¯åŠ¨
3. åŸºç¡€MQTTåŠŸèƒ½æµ‹è¯•
4. å®æ—¶çŠ¶æ€åé¦ˆæµ‹è¯•
5. æ•…éšœæ’é™¤å’Œæ€§èƒ½éªŒè¯

æŒ‰ç…§æœ¬æŒ‡å—æ‰§è¡Œæµ‹è¯•ï¼Œå¯ä»¥å…¨é¢éªŒè¯ä¸­åŠ›å…·èº«æœºå™¨äººç³»ç»Ÿæ–°åè®®çš„åŠŸèƒ½å’Œæ€§èƒ½ã€‚

# å¼€ä¼šé‡ç‚¹è¯¢é—®
## åœ°å›¾ éœ€è¦æ ‡æ³¨å§

å®šä½ä¿¡æ¯å¦‚ä½•è·å–:ros2 emq ros1 å®æ—¶æ€§
è½¨è¿¹ä¸‹å‘å‡ ç±³
æ—¶é—´å»¶æ—¶
zmq ç‰ˆæœ¬å·
æ§åˆ¶ï¼šè§£æå‘½ä»¤ï¼Œæ¥å®šä½

## éœ€è¦åœ¨æµ‹è¯•è½¦ä¸Šéƒ¨ç½²è¿™ä¸ªæ¡†æ¶ä»¥åŠåè®®
å¼€å¯å®é™…æµ‹è¯•

demo æ˜¯ä¸€æ¬¡ä¸‹å‘
ä»»åŠ¡é‡æ–°å¼€å§‹å
æ‰˜ç›˜ä¸­å¿ƒç‚¹x,y,z
åè½´ä¸­å¿ƒä½œä¸ºä¼ æ„Ÿå™¨å‚è€ƒ

æ ‡å®šï¼šè½¬ä¸€åœˆï¼Œè½¦åœä¸‹æ¥çš„æœ€åä¸€ä¸ªå€¼
æ ‡å®šç²¾åº¦ï¼š2å˜ç±³ï¼Œ0.5åº¦
