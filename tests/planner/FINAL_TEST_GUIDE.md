# ComplexTrajectoryPlanner 最终测试指南

## 完整理解

### 背景：第一个规划器
- **SimpleTrajectoryPlanner** 已完成
- 示例：从 (0.0, 0.0, 0.0) → (3.0, 0.0, 1.57即90°)
- 轨迹：沿X正方向行驶3米 → 右转90°

### 任务：第二个规划器（ComplexTrajectoryPlanner）

**起点**: (3.0, 0.0, 1.57) 即 90°
**终点**: (4.0, 1.0, -1.57) 即 -90°
**倒车距离**: 1.0米（固定）

#### 轨迹拆分

**第1段（前向）**:
1. 第一次转弯：从 90° → 0° （右转90°）
2. 前进：1.0米（从x=3.0到x=4.0）
3. 第二次转弯：从 0° → -90° （右转90°）
4. 到达：(4.0, 0.0, -90°)

**第2段（后向/倒车）**:
5. 倒车：1.0米
   - 车头朝向-90°（-Y方向）
   - 车尾方向90°（+Y方向）
   - 沿车尾方向移动
6. 到达：(4.0, 1.0, -90°) ✅

## 测试步骤（4个终端）

### 终端1：MQTT Bridge

```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
./start_mqtt_bridge.sh
```

### 终端2：发布Odom（起点）

```bash
# 起点: (3.0, 0.0, 90°)
python3 publish_test_odom.py --x 3.0 --y 0.0 --yaw-deg 90
```

### 终端3：测试节点

```bash
python3 test_complex_planner_workflow.py
```

### 终端4：发布目标点

```bash
# 终点: (4.0, 1.0, -90°)
python3 publish_test_goal.py --x 4.0 --y 1.0 --yaw-deg -90
```

## 期望输出

### 终端3应该显示：

```
================================================================================
📤 规划并发布前向轨迹（Traj1 + Traj2 组合）
================================================================================
📡 获取最新Odom数据...

📍 起点: (3.000, 0.000), yaw=1.571 (90.0°)
📍 终点: (4.000, 1.000), yaw=-1.571 (-90.0°)

📍 中间点（第1段终点，第2段起点）:
   位置: (4.000, 0.000)
   朝向: -1.571 (-90.0°)

📐 自动计算参数:
   第一次转弯: -1.571 rad (-90.0°) [右转90°]
   前进距离: 1.000 m
   第二次转弯: -1.571 rad (-90.0°) [右转90°]

📍 第1段轨迹终点验证:
   规划终点: (4.000, 0.000), yaw=-1.571 (-90.0°)
   中间点: (4.000, 0.000), yaw=-1.571 (-90.0°)
   位置误差: 0.000 m
   朝向误差: 0.000 rad (0.0°)

📋 复杂前向轨迹规划:
   起点: (3.000, 0.000), yaw=1.571 (90.0°)
   第一次左转: -90.0°  [实际是右转]
   前进距离: 1.000m
   第二次左转: -90.0°  [实际是右转]
   阶段1: 原地左转 -90.0°
   阶段2: 前进 1.000m (点间距0.15m, 7个点)
   阶段3: 原地左转 -90.0°
   ✅ 前向轨迹规划完成: 共 9 个路径点
   终点: (4.000, 0.000), yaw=-1.571 (-90.0°)

✅ 前向轨迹生成完成，共 9 个路径点

所有路径点:
  点1: x=3.000, y=0.000, yaw=1.571 (90.0°)
  点2: x=3.000, y=0.000, yaw=0.000 (0.0°)
  点3: x=3.150, y=0.000, yaw=0.000 (0.0°)
  点4: x=3.300, y=0.000, yaw=0.000 (0.0°)
  点5: x=3.450, y=0.000, yaw=0.000 (0.0°)
  点6: x=3.600, y=0.000, yaw=0.000 (0.0°)
  点7: x=3.750, y=0.000, yaw=0.000 (0.0°)
  点8: x=3.900, y=0.000, yaw=0.000 (0.0°)
  点9: x=4.000, y=0.000, yaw=-1.571 (-90.0°)

Beta-3参数: orientation=0.0, flag=0 (前向运动)
================================================================================
```

**（等待MQTT完成信号后）**

```
================================================================================
📤 规划并发布后向轨迹（Traj3 倒车）
================================================================================
📡 获取最新Odom数据...

📋 后向轨迹规划 (倒车):
   起点: (4.000, 0.000), yaw=-1.571 (-90.0°)
   倒车距离: 1.000m
   生成路径点: 7个 (点间距0.15m)
   ✅ 后向轨迹规划完成: 共 7 个路径点
   终点: (4.000, 1.000), yaw=-1.571 (-90.0°)

✅ 后向轨迹生成完成，共 7 个路径点

所有路径点:
  点1: x=4.000, y=0.000, yaw=-1.571 (-90.0°)
  点2: x=4.000, y=0.150, yaw=-1.571 (-90.0°)
  点3: x=4.000, y=0.300, yaw=-1.571 (-90.0°)
  点4: x=4.000, y=0.450, yaw=-1.571 (-90.0°)
  点5: x=4.000, y=0.600, yaw=-1.571 (-90.0°)
  点6: x=4.000, y=0.750, yaw=-1.571 (-90.0°)
  点7: x=4.000, y=0.900, yaw=-1.571 (-90.0°)
  点8: x=4.000, y=1.000, yaw=-1.571 (-90.0°)

Beta-3参数: orientation=3.14, flag=1 (倒车运动)
容器信息: type=AGV-T300, pos=(5.000, 1.000)
================================================================================
```

## 关键修正

### 1. 倒车方向修正 ✅

**原实现（错误）**：
```python
x = start_x - dist * math.cos(start_yaw)  # 错误
y = start_y - dist * math.sin(start_yaw)
```

**新实现（正确）**：
```python
# 车尾方向 = 车头方向 + 180°
backward_yaw = start_yaw + math.pi
x = start_x + dist * math.cos(backward_yaw)  # 正确
y = start_y + dist * math.sin(backward_yaw)
```

### 2. 前向轨迹计算 ✅

**策略**：
1. 计算中间点（倒车前的位置）
2. 第一次转弯到0°
3. 前进X方向的差值
4. 第二次转弯到目标朝向

### 3. 打印所有路径点 ✅

前向和后向轨迹都打印所有路径点，不省略。

## 验证清单

- [ ] 第1段轨迹共9个路径点（2个转弯点 + 7个前进点）
- [ ] 第1段终点：(4.0, 0.0, -90°)
- [ ] 第2段轨迹共7-8个路径点（倒车）
- [ ] 第2段终点：(4.0, 1.0, -90°) ✅匹配目标
- [ ] 两段轨迹都打印所有路径点
- [ ] Beta-3参数正确（第1段flag=0，第2段flag=1）

## 坐标系理解

**右手法则，Z轴朝下**：
- 0° = +X方向（前）
- 90° = +Y方向（右）
- -90° = -Y方向（左）
- 180° or -180° = -X方向（后）

**倒车定义**：
- 车头朝向θ
- 倒车 = 沿着车尾方向（θ + 180°）移动
- 车头朝向保持不变

## 总结

✅ **第1段轨迹**：右转90° → 前进1米 → 右转90°
✅ **第2段轨迹**：倒车1米
✅ **最终到达**：(4.0, 1.0, -90°)

完美匹配你的需求！🎯
