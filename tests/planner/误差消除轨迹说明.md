# 误差消除轨迹功能说明

## 概述

为了解决旋转开环控制给x,y坐标带来的累积误差，在观察点完成后增加了一段"误差消除轨迹"。

## 问题背景

**原问题：**
- 第一个观察点完成后，车子向右转了90度（-90°，右手坐标系）
- 第二个取货点位置可能距离观察点很近
- 由于旋转是开环控制，会给x,y带来较大误差

**解决方案：**
- 在观察点完成后，先让车子回正（-90° → 0°）
- 然后倒车0.6米，利用直行轮速计校准x,y位置
- 再从新位置开始规划第二条取货轨迹

## 新增轨迹流程

### 原流程（2段轨迹）
```
起点(0.0, 0.0, 0°)
  → [观察点轨迹] → (3.0, 0.0, -90°)
  → [取货前向轨迹] → (4.0, 0.0, -90°)
  → [取货倒车轨迹] → (4.0, 1.0, -90°)
```

### 新流程（3段轨迹，启用误差消除）
```
起点(0.0, 0.0, 0°)
  → [观察点轨迹] → (3.0, 0.0, -90°)
  → [误差消除轨迹] → (2.4, 0.0, 0°)  ← 新增！回正+倒车沿-x方向
  → [取货前向轨迹] → (4.0, 0.0, 0°)
  → [取货倒车轨迹] → (4.0, goal_y, 0°)
```

## 配置参数

在代码开头（第39-41行）：

```python
# 误差消除轨迹配置
ENABLE_CORRECTION_TRAJECTORY = True  # 是否启用误差消除轨迹（观察点完成后回正+倒车）
CORRECTION_BACKWARD_DISTANCE = 0.6   # 误差消除轨迹的倒车距离（米）
```

### 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `ENABLE_CORRECTION_TRAJECTORY` | bool | True | 功能开关，True=启用误差消除，False=使用原流程 |
| `CORRECTION_BACKWARD_DISTANCE` | float | 0.6 | 倒车距离（米），可根据实际情况调整 |

## 使用方法

### 1. 启用误差消除（默认）

```python
ENABLE_CORRECTION_TRAJECTORY = True
CORRECTION_BACKWARD_DISTANCE = 0.6
```

**测试命令：**
```bash
# 启动规划器
python3 unified_planner_workflow.py

# 发布观察点（注意：yaw-deg改为-90，右手坐标系）
python3 publish_test_goal.py --x 3.0 --y 0.0 --yaw-deg -90

# 等待观察点完成...

# 发布取货点（注意：yaw-deg改为0，因为误差消除后车子已回正）
python3 publish_test_goal.py --x 4.0 --y 1.0 --yaw-deg 0
```

**执行流程：**
1. 观察点轨迹：(0, 0, 0°) → (3, 0, -90°)
2. 误差消除轨迹：(3, 0, -90°) → 回正 → (2.4, 0, 0°)（倒车沿-x）
3. 取货前向轨迹：(2.4, 0, 0°) → (4, 0, 0°)
4. 取货倒车轨迹：(4, 0, 0°) → (4, 1.0, 0°)

### 2. 禁用误差消除（兼容模式）

```python
ENABLE_CORRECTION_TRAJECTORY = False
```

**测试命令：**
```bash
# 发布观察点
python3 publish_test_goal.py --x 3.0 --y 0.0 --yaw-deg -90

# 发布取货点（yaw-deg保持-90，与观察点相同）
python3 publish_test_goal.py --x 4.0 --y 1.0 --yaw-deg -90
```

**执行流程（原流程）：**
1. 观察点轨迹：(0, 0, 0°) → (3, 0, -90°)
2. 取货前向轨迹：(3, 0, -90°) → (4, 0, -90°)
3. 取货倒车轨迹：(4, 0, -90°) → (4, 1.0, -90°)

## 技术细节

### 误差消除轨迹规划

**方法名：** `plan_and_publish_correction_trajectory()`

**规划策略：**
1. 从 `/Odom` 获取观察点终点的实时位置（考虑旋转误差）
2. 阶段1：原地旋转回正（start_yaw → 0°）
3. 阶段2：倒车 `CORRECTION_BACKWARD_DISTANCE` 米（沿-x方向，y不变）

**Beta-3参数：**
- `orientation=3.14`（倒车朝向）
- `flag=0`（正常倒车）

**轨迹ID格式：**
- `correction_{timestamp}`

### 起点获取

**所有轨迹的起点都从 `/Odom` 实时读取：**
- 观察点轨迹：从初始Odom或默认位置开始
- 误差消除轨迹：从观察点完成后的Odom读取（包含旋转误差）
- 取货前向轨迹：从误差消除完成后的Odom读取（已校准）
- 取货倒车轨迹：从取货前向完成后的Odom读取

### MQTT完成处理

在 `on_mqtt_message()` 中新增处理逻辑（第648-660行）：

```python
elif "correction" in self.current_trajectory_id:
    # 更新Odom为误差消除轨迹终点
    self.update_odom_from_trajectory_end(self.correction_trajectory_waypoints)

    # 等待3秒后规划取货轨迹
    time.sleep(3)

    # 使用保存的目标点规划取货轨迹
    if self.pending_pickup_goal:
        self.plan_and_publish_complex(self.pending_pickup_goal)
```

## 优点与效果

### ✅ 优点

1. **消除旋转误差**：倒车0.6米可以用真实轮速计校准x,y坐标
2. **简化第二条轨迹**：车子已回正(0°)，取货轨迹规划更简单
3. **保持原架构**：仍然使用 `ComplexTrajectoryPlanner`，代码改动最小
4. **易于调试**：增加独立轨迹段，可单独验证
5. **参数可配置**：倒车距离放在开头，方便调整
6. **功能开关**：一键切换新旧流程，增强兼容性

### 📊 预期效果

- **定位精度提升**：通过直行轮速计校准，减少xy误差
- **取货成功率提升**：起点位置更准确，取货对位更精确
- **易于维护**：参数外置，测试/生产环境切换方便

## 注意事项

### 1. 坐标系说明

**右手坐标系，z轴朝上：**
- 向右转90度 = `-90°`
- 向左转90度 = `+90°`
- 回正到x轴正方向 = `0°`

### 2. 目标点朝向调整

启用误差消除后，第二个目标点的朝向需要调整：

| 模式 | 第一个点yaw | 第二个点yaw | 说明 |
|------|------------|------------|------|
| 启用误差消除 | -90° | 0° | 误差消除后车子已回正 |
| 禁用误差消除 | -90° | -90° | 保持原朝向 |

### 3. 测试环境 vs 生产环境

**测试环境（当前）：**
- 使用 `update_odom_from_trajectory_end()` 模拟位置更新
- 每段轨迹完成后手动更新 `/Odom`

**生产环境：**
- 注释掉 `update_odom_from_trajectory_end()` 调用
- 使用真实的定位系统提供 `/Odom` 数据
- 代码中已标记TODO注释，方便切换

### 4. 参数调优建议

**倒车距离选择：**
- 默认 `0.6米`，可根据实际测试效果调整
- 距离越长，校准效果越好，但耗时增加
- 建议范围：0.3米 ~ 1.0米

## 完整测试流程

### 终端1：启动MQTT Bridge
```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
./start_mqtt_bridge.sh
```

### 终端2：启动模拟执行器
```bash
python3 mock_executor.py
```

### 终端3：启动统一规划器
```bash
python3 unified_planner_workflow.py
```

**预期输出：**
```
🚀 统一轨迹规划器
================================================================================
📋 使用说明：
  1. 本程序启动后等待目标点
  2. 【第1个点 - 观察点】使用 SimpleTrajectoryPlanner（前进 + 转弯）
  3. 【第2个点 - 取货点】使用 误差消除轨迹 + ComplexTrajectoryPlanner
     - 步骤1: 回正 + 倒车0.6米（消除旋转误差）
     - 步骤2: 转弯 + 前进 + 转弯 + 倒车（到达取货点）
================================================================================

✅ 统一轨迹规划器已启动
   规划器1: SimpleTrajectoryPlanner（观察点）
   规划器2: ComplexTrajectoryPlanner（取货点）
   Service: /trajectory_status（轨迹状态查询）
   Service: /go_to_pose（接收调度器目标点）
   误差消除轨迹: 启用
   - 倒车距离: 0.6米
```

### 终端4：发布目标点

**步骤1：发布观察点**
```bash
python3 publish_test_goal.py --x 3.0 --y 0.0 --yaw-deg -90
```

**等待观察点完成...**

**步骤2：发布取货点**
```bash
python3 publish_test_goal.py --x 4.0 --y 1.0 --yaw-deg 0
```

## 代码修改总结

### 文件：`unified_planner_workflow.py`

**新增配置参数（第39-41行）：**
```python
ENABLE_CORRECTION_TRAJECTORY = True
CORRECTION_BACKWARD_DISTANCE = 0.6
```

**新增状态变量（第84行）：**
```python
self.pending_pickup_goal = None  # 暂存第二个目标点
```

**新增方法（第233-299行）：**
```python
def plan_and_publish_correction_trajectory(self):
    """规划并发布误差消除轨迹（回正 + 倒车）"""
```

**新增辅助方法（第676-683行）：**
```python
@staticmethod
def _normalize_angle(angle: float) -> float:
    """将角度归一化到 [-pi, pi]"""
```

**修改目标点处理逻辑（第165-178行）：**
- 第2个点收到后，根据开关选择规划策略
- 启用时：先发布误差消除轨迹，暂存目标点
- 禁用时：直接规划取货轨迹（原逻辑）

**修改MQTT完成处理（第648-660行）：**
- 新增 `correction` 轨迹完成后的处理
- 更新Odom后，规划取货轨迹

**修改启动提示（第741-789行）：**
- 根据开关显示不同的使用说明
- 提示正确的yaw角度值

## 版本历史

- **v1.0** (2025-10-08)：初始版本，新增误差消除轨迹功能

## 联系方式

如有问题，请查看：
- 代码仓库：`/home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner/`
- 统一规划器：`unified_planner_workflow.py`
- 使用指南：`统一规划器使用指南.md`
