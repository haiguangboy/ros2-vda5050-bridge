# ComplexTrajectoryPlanner 闭环测试指南

## 完整闭环系统架构

```
┌─────────────┐     MQTT      ┌──────────────┐
│MQTT Bridge  │◄─────────────►│Mock Executor │
│(终端1)      │  trajectory   │(终端2)       │
└─────────────┘    status      └──────────────┘
       ▲                              ▲  │
       │ /plans                 /Odom │  │ /plans
       │                              │  │
       │                          ┌───┴──▼────┐
       │                          │  Test     │
       └──────────────────────────┤  Workflow │
                                  │  (终端4)  │
                                  └───▲───────┘
                                      │ /Odom, /nav_goal
                                      │
                            ┌─────────┴──────────┐
                            │                    │
                    ┌───────▼────┐      ┌────────▼──────┐
                    │Odom         │      │Goal           │
                    │Publisher    │      │Publisher      │
                    │(终端3)      │      │(终端5)        │
                    └─────────────┘      └───────────────┘
```

## 测试场景

**起点**: (3.0, 0.0, -1.57)  即 (3.0, 0.0, -90°)
**终点**: (4.0, 1.0, 1.57)   即 (4.0, 1.0, 90°)
**倒车距离**: 1.0米

### 轨迹拆分

- **第1段（前向）**: 转弯 → 前进 → 转弯 (flag=0)
- **第2段（后向）**: 倒车1米 (flag=1)

---

## 完整测试步骤（5个终端）

### 终端1：启动MQTT Bridge

```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
./start_mqtt_bridge.sh
```

**期望输出**：
```
✅ 中力MQTT客户端已创建 - Robot ID: robot-001
✅ 已连接到EMQX服务器
📡 已订阅主题: EP/master/robot-001/task
```

⚠️ **保持运行！**

---

### 终端2：启动模拟执行器（NEW！）

```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
python3 mock_executor.py
```

**期望输出**：
```
🎮 模拟轨迹执行器
================================================================================
功能:
  1. 接收 /plans 轨迹指令
  2. 模拟执行轨迹（延时）
  3. 发布MQTT状态消息（running → completed）
  4. 更新 /Odom 当前位置
================================================================================

✅ 模拟执行器已启动
   订阅: /plans
   发布: /Odom (当前位置)
   MQTT: 发布轨迹状态

🚀 连接到MQTT代理: localhost:1883
✅ MQTT已连接

💡 执行器运行中，按 Ctrl+C 停止
```

⚠️ **保持运行！这是形成闭环的关键组件！**

---

### 终端3：发布Odom数据（起点）

```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
python3 publish_test_odom.py --x 3.0 --y 0.0 --yaw-deg -90
```

**期望输出**：
```
✅ 持续发布Odom数据到 /Odom:
   位置: (3.000, 0.000)
   朝向: -1.570 rad (-90.0°)
   发布频率: 10 Hz
   按 Ctrl+C 停止
```

⚠️ **保持运行！**

---

### 终端4：启动测试节点

```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
python3 test_complex_planner_workflow.py
```

**期望输出**：
```
🧪 ComplexTrajectoryPlanner 完整工作流程测试
================================================================================
测试说明：
  1. 等待 /Odom 获取当前位置（起点）
  2. 等待 /nav_goal 获取目标点
  3. 自动计算转弯角度和前进距离
  4. 规划并发布前向轨迹（两次转弯 + 前进）
  5. 等待完成后规划并发布后向轨迹（倒车1米）
================================================================================
倒车距离: 1.0m
================================================================================

✅ ComplexPlannerTester 节点已启动
⏳ 等待 /Odom 话题数据（最多等待 10 秒）...
✅ 已接收到 /Odom 话题数据
   当前位置: (3.000, 0.000), 朝向: -1.571 (-90.0°)

⏳ 等待目标点 /nav_goal 话题数据...
   无超时限制（按Ctrl+C可中断）
```

**此时等待目标点...**

---

### 终端5：发布目标点

```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
python3 publish_test_goal.py --x 4.0 --y 1.0 --yaw-deg 90
```

**期望输出**：
```
✅ 准备发布目标点到 /nav_goal:
   位置: (4.000, 1.000)
   朝向: 1.570 rad (90.0°)
   发布频率: 10 Hz，持续2秒

📤 已发布 5/20 次...
📤 已发布 10/20 次...
📤 已发布 15/20 次...
📤 已发布 20/20 次...
✅ 已发布 20 次，完成
```

---

## 完整闭环输出示例

### 终端4（测试节点）会显示：

```
✅ 已接收到目标点 /nav_goal
   目标位置: (4.000, 1.000), 朝向: 1.571 (90.0°)

================================================================================
📤 规划并发布前向轨迹（Traj1 + Traj2 组合）
================================================================================
📡 获取最新Odom数据...

📍 起点: (3.000, 0.000), yaw=-1.571 (-90.0°)
📍 终点: (4.000, 1.000), yaw=1.571 (90.0°)

📐 自动计算参数:
   第一次转弯: 0.785 rad (45.0°)
   前进距离: 1.414 m
   第二次转弯: 0.785 rad (45.0°)

✅ 前向轨迹生成完成，共 12 个路径点

所有路径点:
  点1: x=3.000, y=0.000, yaw=-1.571 (-90.0°)
  点2: x=3.000, y=0.000, yaw=-0.785 (-45.0°)
  点3: x=3.106, y=0.106, yaw=-0.785 (-45.0°)
  ...
  点12: x=4.000, y=1.000, yaw=1.571 (90.0°)

Beta-3参数: orientation=0.0, flag=0 (前向运动)
================================================================================
📤 轨迹已发布到 /plans

⏳ 等待MQTT轨迹完成信号（按Ctrl+C可中断）...
```

### 终端2（模拟执行器）会显示：

```
================================================================================
📥 收到轨迹指令
================================================================================
📋 轨迹ID: complex_forward_XXXXXXXXXX
📍 路径点数: 12
🔄 orientation: 0.0
🌿 flag: 0

起点: (3.000, 0.000), yaw=-90.0°
终点: (4.000, 1.000), yaw=90.0°

执行估算:
  移动距离: 1.414 m
  旋转角度: 180.0°
  预计时间: 1.2 秒
================================================================================
📤 发布状态: running

⏳ 模拟执行轨迹... (1.2秒)
  进度: 40% - 位置: (3.42, 0.42)
  进度: 80% - 位置: (3.85, 0.85)
✅ 执行完成

📤 发布状态: completed
📍 当前位置: (4.000, 1.000), yaw=90.0°
```

### 终端4（测试节点）继续显示：

```
================================================================================
📊 收到MQTT轨迹状态消息
================================================================================
📋 轨迹ID: complex_forward_XXXXXXXXXX
📍 状态: completed
⏰ 时间戳: XXXXXXXXXX

✅ 轨迹已完成！
================================================================================

✅ 前向轨迹已完成，等待3秒后发布后向轨迹...

================================================================================
📤 规划并发布后向轨迹（Traj3 倒车）
================================================================================
📡 获取最新Odom数据...

📋 后向轨迹规划 (倒车):
   起点: (4.000, 1.000), yaw=1.571 (90.0°)
   倒车距离: 1.000m
   生成路径点: 7个 (点间距0.15m)
   ✅ 后向轨迹规划完成: 共 7 个路径点
   终点: (4.000, 0.000), yaw=1.571 (90.0°)

✅ 后向轨迹生成完成，共 7 个路径点

所有路径点:
  点1: x=4.000, y=1.000, yaw=1.571 (90.0°)
  点2: x=4.000, y=0.850, yaw=1.571 (90.0°)
  ...
  点7: x=4.000, y=0.000, yaw=1.571 (90.0°)

Beta-3参数: orientation=3.14, flag=1 (倒车运动)
容器信息: type=AGV-T300, pos=(5.000, 2.000)
================================================================================
📤 轨迹已发布到 /plans

✅ 所有轨迹发布完成
💡 保持运行以监听MQTT轨迹消息...
```

### 终端2（模拟执行器）再次显示：

```
================================================================================
📥 收到轨迹指令
================================================================================
📋 轨迹ID: complex_backward_XXXXXXXXXX
📍 路径点数: 7
🔄 orientation: 3.14
🌿 flag: 1

起点: (4.000, 1.000), yaw=90.0°
终点: (4.000, 0.000), yaw=90.0°

执行估算:
  移动距离: 1.000 m
  旋转角度: 0.0°
  预计时间: 0.5 秒
================================================================================
📤 发布状态: running

⏳ 模拟执行轨迹... (0.5秒)
✅ 执行完成

📤 发布状态: completed
📍 当前位置: (4.000, 0.000), yaw=90.0°
```

### 终端4（测试节点）最终显示：

```
================================================================================
📊 收到MQTT轨迹状态消息
================================================================================
📋 轨迹ID: complex_backward_XXXXXXXXXX
📍 状态: completed

✅ 轨迹已完成！
================================================================================
```

---

## 闭环验证清单

- [ ] 终端1：MQTT Bridge运行正常
- [ ] 终端2：模拟执行器运行正常（关键！）
- [ ] 终端3：Odom数据持续发布
- [ ] 终端4：测试节点收到Odom和目标点
- [ ] 终端4：前向轨迹成功发布
- [ ] 终端2：模拟执行器收到前向轨迹
- [ ] 终端2：发布"running"状态
- [ ] 终端2：模拟延时执行
- [ ] 终端2：更新Odom位置
- [ ] 终端2：发布"completed"状态
- [ ] 终端4：收到MQTT完成信号（不再卡住！）
- [ ] 终端4：后向轨迹成功发布
- [ ] 终端2：模拟执行器收到后向轨迹
- [ ] 终端2：再次发布"running" → "completed"
- [ ] 终端4：收到第二次完成信号
- [ ] ✅ 完整闭环测试成功！

---

## 快速测试命令汇总

```bash
# 终端1
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
./start_mqtt_bridge.sh

# 终端2（NEW！闭环关键组件）
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
python3 mock_executor.py

# 终端3
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
python3 publish_test_odom.py --x 3.0 --y 0.0 --yaw-deg -90

# 终端4
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
python3 test_complex_planner_workflow.py

# 终端5（等终端4启动后）
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
python3 publish_test_goal.py --x 4.0 --y 1.0 --yaw-deg 90
```

---

## 故障排查

### 问题1：测试节点卡在"等待MQTT轨迹完成信号"

**原因**：模拟执行器未运行

**解决**：启动终端2运行 `mock_executor.py`

### 问题2：模拟执行器没有收到轨迹

**原因**：MQTT Bridge未运行或ROS2话题未连接

**解决**：
- 确保终端1运行MQTT Bridge
- 使用 `ros2 topic list` 检查 `/plans` 话题
- 使用 `ros2 topic echo /plans` 监听轨迹发布

### 问题3：MQTT状态消息未收到

**原因**：MQTT连接问题

**解决**：
- 检查MQTT代理是否运行（localhost:1883）
- 检查模拟执行器MQTT连接状态
- 检查测试节点MQTT订阅状态

---

## 关键改进：闭环实现

### 之前的问题
测试节点发布轨迹后，等待MQTT完成信号时**永久卡住**，因为没有组件返回完成状态。

### 现在的解决方案
**mock_executor.py** 模拟真实执行器的完整行为：
1. ✅ 订阅 `/plans` 接收轨迹
2. ✅ 解析轨迹参数（ID、orientation、flag等）
3. ✅ 计算执行时间（基于距离和旋转角度）
4. ✅ 发布MQTT "running"状态
5. ✅ 模拟延时执行
6. ✅ 逐步更新 `/Odom` 位置
7. ✅ 发布MQTT "completed"状态
8. ✅ 测试节点收到完成信号，继续下一步

### 闭环流程
```
测试节点发布前向轨迹
    ↓
模拟执行器接收并执行
    ↓
发布"completed"状态
    ↓
测试节点收到完成信号
    ↓
发布后向轨迹
    ↓
模拟执行器接收并执行
    ↓
发布"completed"状态
    ↓
✅ 测试完成！
```

---

## 总结

✅ **完整闭环测试系统已实现！**

核心组件：
1. MQTT Bridge - 连接ROS2和MQTT
2. **Mock Executor - 模拟执行器（NEW！关键！）**
3. Odom Publisher - 发布起点位置
4. Test Workflow - 规划器测试节点
5. Goal Publisher - 发布目标点

系统特性：
- ✅ 自动规划复杂轨迹
- ✅ 前向和后向轨迹分离
- ✅ Beta-3协议完整支持
- ✅ MQTT状态反馈闭环
- ✅ 位置更新实时同步
- ✅ 完整端到端测试

开始测试吧！🚀🎯
