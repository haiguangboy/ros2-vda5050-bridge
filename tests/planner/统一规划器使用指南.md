# 统一轨迹规划器使用指南

## 概述

**unified_planner_workflow.py** - 自动选择规划策略的统一规划器

- **第1个点（观察点）** → SimpleTrajectoryPlanner（前进 + 转弯）
- **第2个点（取货点）** → ComplexTrajectoryPlanner（转弯 + 前进 + 转弯 + 倒车）

---

## 快速开始（4个终端）

### 终端1：MQTT Bridge
```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
./start_mqtt_bridge.sh
```

### 终端2：模拟执行器
```bash
python3 mock_executor.py
```

### 终端3：统一规划器（新！）
```bash
python3 unified_planner_workflow.py
```

**启动后会显示**：
```
🚀 统一轨迹规划器
================================================================================
📋 使用说明：
  1. 本程序启动后等待目标点
  2. 【第1个点 - 观察点】使用 SimpleTrajectoryPlanner（前进 + 转弯）
  3. 【第2个点 - 取货点】使用 ComplexTrajectoryPlanner（转弯 + 前进 + 转弯 + 倒车）
================================================================================

⏳ 等待 /Odom 话题数据...

✅ 已接收到 /Odom 话题数据
   当前位置: (0.000, 0.000), 朝向: 0.000 (0.0°)

================================================================================
📍 请按顺序发布目标点：

第1步 - 发布观察点：
  python3 publish_test_goal.py --x 3.0 --y 0.0 --yaw-deg 90

第2步 - 等待第1段轨迹完成后，发布取货点：
  python3 publish_test_goal.py --x 4.0 --y 1.0 --yaw-deg 90
================================================================================

💡 等待目标点，按 Ctrl+C 停止
```

### 终端4：发布目标点

#### 第1步：发布观察点
```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
python3 publish_test_goal.py --x 3.0 --y 0.0 --yaw-deg 90
```

**等待第1段轨迹完成...**

#### 第2步：发布取货点
```bash
python3 publish_test_goal.py --x 4.0 --y 1.0 --yaw-deg 90
```

---

## 完整输出示例

### 终端3（统一规划器）- 第1个点

```
================================================================================
📍 第1个目标点（观察点）
================================================================================
目标位置: (3.000, 0.000), 朝向: 1.571 (90.0°)
规划策略: SimpleTrajectoryPlanner（前进 + 转弯）

🔧 使用 SimpleTrajectoryPlanner 规划轨迹...
--------------------------------------------------------------------------------
📍 起点: (0.000, 0.000), yaw=0.000 (0.0°)
📍 终点: (3.000, 0.000), yaw=1.571 (90.0°)

📐 自动计算参数:
   前进距离: 3.000 m
   转弯角度: 1.571 rad (90.0°)

📋 简单轨迹规划:
   起点: (0.000, 0.000), yaw=0.000 (0.0°)
   前进距离: 3.000m
   转弯角度: 90.0°（右转）
   阶段1: 前进 3.000m (点间距0.15m, 21个点)
   阶段2: 原地右转 90.0°
   ✅ 轨迹规划完成: 共 22 个路径点
   终点: (3.000, 0.000), yaw=1.571 (90.0°)

✅ 轨迹生成完成，共 22 个路径点

所有路径点:
  点1: x=0.000, y=0.000, yaw=0.000 (0.0°)
  点2: x=0.150, y=0.000, yaw=0.000 (0.0°)
  ...
  点21: x=3.000, y=0.000, yaw=0.000 (0.0°)
  点22: x=3.000, y=0.000, yaw=1.571 (90.0°)

Beta-3参数: orientation=0.0, flag=0
================================================================================
📤 第1段轨迹已发布（观察点）
📋 轨迹ID: observation_1728087654321
⏳ 等待MQTT完成信号...

================================================================================
📊 收到MQTT轨迹完成信号
================================================================================
📋 轨迹ID: observation_1728087654321
📍 状态: completed
✅ 轨迹已完成！
================================================================================
```

### 终端3（统一规划器）- 第2个点

```
================================================================================
📍 第2个目标点（取货点）
================================================================================
目标位置: (4.000, 1.000), 朝向: 1.571 (90.0°)
规划策略: ComplexTrajectoryPlanner（转弯 + 前进 + 转弯 + 倒车）

🔧 使用 ComplexTrajectoryPlanner 规划轨迹...
--------------------------------------------------------------------------------
📍 起点: (3.000, 0.000), yaw=1.571 (90.0°)
📍 终点: (4.000, 1.000), yaw=1.571 (90.0°)

📍 中间点（倒车前位置）:
   位置: (4.000, 0.000)
   朝向: 1.571 (90.0°)

📐 前向轨迹参数:
   第一次转弯: -1.571 rad (-90.0°)
   前进距离: 1.000 m
   第二次转弯: 1.571 rad (90.0°)

📋 复杂前向轨迹规划:
   起点: (3.000, 0.000), yaw=1.571 (90.0°)
   第一次左转: -90.0°
   前进距离: 1.000m
   第二次左转: 90.0°
   阶段1: 原地左转 -90.0°
   阶段2: 前进 1.000m (点间距0.15m, 7个点)
   阶段3: 原地左转 90.0°
   ✅ 前向轨迹规划完成: 共 9 个路径点
   终点: (4.000, 0.000), yaw=1.571 (90.0°)

✅ 前向轨迹生成完成，共 9 个路径点

所有路径点:
  点1: x=3.000, y=0.000, yaw=1.571 (90.0°)
  点2: x=3.000, y=0.000, yaw=0.000 (0.0°)
  点3: x=3.150, y=0.000, yaw=0.000 (0.0°)
  ...
  点9: x=4.000, y=0.000, yaw=1.571 (90.0°)

Beta-3参数: orientation=0.0, flag=0
================================================================================
📤 第2段轨迹（前向）已发布
📋 轨迹ID: pickup_forward_1728087658890
⏳ 等待MQTT完成信号，然后发布倒车轨迹...

================================================================================
📊 收到MQTT轨迹完成信号
================================================================================
📋 轨迹ID: pickup_forward_1728087658890
📍 状态: completed
✅ 轨迹已完成！
================================================================================

⏳ 等待3秒后发布倒车轨迹...

================================================================================
📤 规划并发布后向轨迹（倒车）
================================================================================

📋 后向轨迹规划 (倒车):
   起点: (4.000, 0.000), yaw=1.571 (90.0°)
   倒车距离: 1.000m
   生成路径点: 7个 (点间距0.15m)
   ✅ 后向轨迹规划完成: 共 7 个路径点
   终点: (4.000, 1.000), yaw=1.571 (90.0°)

✅ 后向轨迹生成完成，共 7 个路径点

所有路径点:
  点1: x=4.000, y=0.000, yaw=1.571 (90.0°)
  点2: x=4.000, y=0.150, yaw=1.571 (90.0°)
  ...
  点7: x=4.000, y=1.000, yaw=1.571 (90.0°)

Beta-3参数: orientation=3.14, flag=1
容器信息: type=AGV-T300, pos=(5.0, 2.0)
================================================================================
📤 第2段轨迹（后向）已发布
📋 轨迹ID: pickup_backward_1728087662345
⏳ 等待MQTT完成信号...

================================================================================
📊 收到MQTT轨迹完成信号
================================================================================
📋 轨迹ID: pickup_backward_1728087662345
📍 状态: completed
✅ 轨迹已完成！
================================================================================

🎉 所有轨迹已完成！
💡 可以继续发布新的目标点...
```

---

## 工作流程图

```
统一规划器                     MQTT/执行器
    │                              │
    ├─── 等待第1个目标点 ──────────┤
    │                              │
    ├─── 收到观察点 ───────────────┤
    │                              │
    ├─── 使用SimpleTrajectoryPlanner
    │                              │
    ├─── 发布第1段轨迹 ───────────→│
    │                              │
    │                         执行轨迹
    │                              │
    │←─── 收到completed ───────────┤
    │                              │
    ├─── 等待第2个目标点 ──────────┤
    │                              │
    ├─── 收到取货点 ───────────────┤
    │                              │
    ├─── 使用ComplexTrajectoryPlanner
    │                              │
    ├─── 发布第2段前向轨迹 ───────→│
    │                              │
    │                         执行轨迹
    │                              │
    │←─── 收到completed ───────────┤
    │                              │
    ├─── 等待3秒 ──────────────────┤
    │                              │
    ├─── 发布第2段后向轨迹 ───────→│
    │                              │
    │                         执行倒车
    │                              │
    │←─── 收到completed ───────────┤
    │                              │
    ✅ 全部完成
```

---

## 与原测试程序的对比

### 原方式（分别测试）

**test_simple_planner_workflow.py**：
- 只测试SimpleTrajectoryPlanner
- 需要手动运行

**test_complex_planner_workflow.py**：
- 只测试ComplexTrajectoryPlanner
- 需要手动运行

### 新方式（统一规划器）⭐

**unified_planner_workflow.py**：
- ✅ 自动选择规划器（根据第1/第2个点）
- ✅ 自动处理观察点 → 取货点流程
- ✅ 启动时打印清晰的使用说明
- ✅ 一次运行完成两段轨迹
- ✅ 实际业务场景更贴合

---

## 验证清单

- [ ] 终端1：MQTT Bridge运行
- [ ] 终端2：mock_executor.py运行
- [ ] 终端3：unified_planner_workflow.py启动成功
- [ ] 终端3：显示使用说明（第1个点 + 第2个点）
- [ ] 终端4：发布第1个目标点（观察点）
- [ ] 终端3：使用SimpleTrajectoryPlanner规划
- [ ] 终端3：发布第1段轨迹
- [ ] 终端2：执行第1段轨迹，返回completed
- [ ] 终端3：收到completed信号
- [ ] 终端4：发布第2个目标点（取货点）
- [ ] 终端3：使用ComplexTrajectoryPlanner规划
- [ ] 终端3：发布第2段前向轨迹
- [ ] 终端2：执行前向轨迹，返回completed
- [ ] 终端3：收到completed，等待3秒
- [ ] 终端3：发布第2段后向轨迹（倒车）
- [ ] 终端2：执行倒车轨迹，返回completed
- [ ] 终端3：收到completed，显示"所有轨迹已完成"
- [ ] ✅ 完整流程成功！

---

## 快速测试命令

```bash
# 终端1
./start_mqtt_bridge.sh

# 终端2
python3 mock_executor.py

# 终端3
python3 unified_planner_workflow.py

# 终端4 - 第1步
python3 publish_test_goal.py --x 3.0 --y 0.0 --yaw-deg 90

# 终端4 - 第2步（等第1段完成后）
python3 publish_test_goal.py --x 4.0 --y 1.0 --yaw-deg 90
```

---

## 总结

✅ **统一规划器的优势**

1. **自动选择策略**：根据目标点顺序自动选择SimpleTrajectoryPlanner或ComplexTrajectoryPlanner
2. **清晰的使用提示**：启动时打印使用说明，告诉用户先发布观察点，再发布取货点
3. **完整业务流程**：模拟真实的观察 → 取货流程
4. **一次运行完成**：不需要切换程序，一次运行完成两段轨迹
5. **易于使用**：使用者只需要按顺序发布2个目标点即可

开始测试吧！🚀
