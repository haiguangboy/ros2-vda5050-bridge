# ComplexTrajectoryPlanner 完整测试指南（基于目标点）

## 测试场景

**起点**: (3.0, 0.0, -1.57)  即 (3.0, 0.0, -90°)
**终点**: (4.0, 1.0, 1.57)   即 (4.0, 1.0, 90°)

### 自动规划结果

系统会自动计算：
1. **第一次转弯**：从起点朝向(-90°)转到朝向目标位置的方向
2. **前进距离**：从起点(3.0, 0.0)到终点(4.0, 1.0)的直线距离
3. **第二次转弯**：从朝向目标位置的方向转到目标朝向(90°)

### 轨迹拆分

- **第1段轨迹（前向）**: 第一次转弯 → 前进 → 第二次转弯（flag=0, orientation=0.0）
- **第2段轨迹（后向）**: 倒车1米（flag=1, orientation=3.14）

---

## 完整测试步骤（4个终端）

### 终端1：启动MQTT Bridge

```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
./start_mqtt_bridge.sh
```

**期望输出**：
```
✅ 中力MQTT客户端已创建 - Robot ID: robot-001
✅ 已连接到EMQX服务器
📡 已订阅主题: EP/master/robot-001/task
```

⚠️ **保持运行！**

---

### 终端2：发布Odom数据（起点）

```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
python3 publish_test_odom.py --x 3.0 --y 0.0 --yaw -1.57
```

或使用度数：
```bash
python3 publish_test_odom.py --x 3.0 --y 0.0 --yaw-deg -90
```

**期望输出**：
```
✅ 持续发布Odom数据到 /Odom:
   位置: (3.000, 0.000)
   朝向: -1.570 rad (-90.0°)
   发布频率: 10 Hz
   按 Ctrl+C 停止
```

⚠️ **保持运行！**

---

### 终端3：启动测试节点

```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
python3 test_complex_planner_workflow.py
```

**期望输出**：
```
🧪 ComplexTrajectoryPlanner 完整工作流程测试
================================================================================
测试说明：
  1. 等待 /Odom 获取当前位置（起点）
  2. 等待 /nav_goal 获取目标点
  3. 自动计算转弯角度和前进距离
  4. 规划并发布前向轨迹（两次转弯 + 前进）
  5. 等待完成后规划并发布后向轨迹（倒车1米）
================================================================================
倒车距离: 1.0m
================================================================================

✅ ComplexPlannerTester 节点已启动
   规划器: ComplexTrajectoryPlanner
   Service: /trajectory_status

🚀 连接到MQTT代理: localhost:1883
✅ MQTT连接成功
📡 订阅轨迹状态主题: EP/robot-001/cerebellum/embrain/trajectory_status

⏳ 等待 /Odom 话题数据（最多等待 10 秒）...
✅ 已接收到 /Odom 话题数据
   当前位置: (3.000, 0.000), 朝向: -1.571 (-90.0°)

✅ 成功获取 /Odom 话题数据

⏳ 等待目标点 /nav_goal 话题数据...
   无超时限制（按Ctrl+C可中断）
```

**此时等待目标点...**

---

### 终端4：发布目标点

```bash
cd /home/yhg/Documents/ep-embodied/mqtt_bridge/tests/planner
python3 publish_test_goal.py --x 4.0 --y 1.0 --yaw 1.57
```

或使用度数：
```bash
python3 publish_test_goal.py --x 4.0 --y 1.0 --yaw-deg 90
```

**期望输出**：
```
✅ 准备发布目标点到 /nav_goal:
   位置: (4.000, 1.000)
   朝向: 1.570 rad (90.0°)
   发布频率: 10 Hz，持续2秒

📤 已发布 5/20 次...
📤 已发布 10/20 次...
📤 已发布 15/20 次...
📤 已发布 20/20 次...
✅ 已发布 20 次，完成
```

---

## 完整输出示例

### 终端3（测试节点）应该显示：

```
✅ 已接收到目标点 /nav_goal
   目标位置: (4.000, 1.000), 朝向: 1.571 (90.0°)

✅ 成功获取目标点数据

⏱️  准备发布前向轨迹...

================================================================================
📤 规划并发布前向轨迹（Traj1 + Traj2 组合）
================================================================================
📡 获取最新Odom数据...

📍 起点: (3.000, 0.000), yaw=-1.571 (-90.0°)
📍 终点: (4.000, 1.000), yaw=1.571 (90.0°)

📐 自动计算参数:
   第一次转弯: 0.785 rad (45.0°)
   前进距离: 1.414 m
   第二次转弯: 0.785 rad (45.0°)

📋 复杂前向轨迹规划:
   起点: (3.000, 0.000), yaw=-1.571 (-90.0°)
   第一次左转: 45.0°
   前进距离: 1.414m
   第二次左转: 45.0°
   阶段1: 原地左转 45.0°
   阶段2: 前进 1.414m (点间距0.15m, 10个点)
   阶段3: 原地左转 45.0°
   ✅ 前向轨迹规划完成: 共 12 个路径点
   终点: (4.000, 1.000), yaw=1.571 (90.0°)

✅ 前向轨迹生成完成，共 12 个路径点

所有路径点:
  点1: x=3.000, y=0.000, yaw=-1.571 (-90.0°)
  点2: x=3.000, y=0.000, yaw=-0.785 (-45.0°)
  点3: x=3.106, y=0.106, yaw=-0.785 (-45.0°)
  点4: x=3.212, y=0.212, yaw=-0.785 (-45.0°)
  点5: x=3.318, y=0.318, yaw=-0.785 (-45.0°)
  点6: x=3.424, y=0.424, yaw=-0.785 (-45.0°)
  点7: x=3.530, y=0.530, yaw=-0.785 (-45.0°)
  点8: x=3.636, y=0.636, yaw=-0.785 (-45.0°)
  点9: x=3.742, y=0.742, yaw=-0.785 (-45.0°)
  点10: x=3.849, y=0.849, yaw=-0.785 (-45.0°)
  点11: x=3.955, y=0.955, yaw=-0.785 (-45.0°)
  点12: x=4.000, y=1.000, yaw=1.571 (90.0°)

Beta-3参数: orientation=0.0, flag=0 (前向运动)
================================================================================
📤 轨迹已发布到 /plans
📋 轨迹ID: complex_forward_XXXXXXXXXX

⏳ 等待MQTT轨迹完成信号（按Ctrl+C可中断）...
```

**（等待MQTT完成信号后）**

```
================================================================================
📊 收到MQTT轨迹状态消息
================================================================================
📋 轨迹ID: complex_forward_XXXXXXXXXX
📍 状态: completed
⏰ 时间戳: XXXXXXXXXX

✅ 轨迹已完成！
================================================================================

✅ 前向轨迹已完成，等待3秒后发布后向轨迹...

================================================================================
📤 规划并发布后向轨迹（Traj3 倒车）
================================================================================
📡 获取最新Odom数据...

📋 后向轨迹规划 (倒车):
   起点: (4.000, 1.000), yaw=1.571 (90.0°)
   倒车距离: 1.000m
   生成路径点: 7个 (点间距0.15m)
   ✅ 后向轨迹规划完成: 共 7 个路径点
   终点: (4.000, 0.000), yaw=1.571 (90.0°)

✅ 后向轨迹生成完成，共 7 个路径点

所有路径点:
  点1: x=4.000, y=1.000, yaw=1.571 (90.0°)
  点2: x=4.000, y=0.850, yaw=1.571 (90.0°)
  点3: x=4.000, y=0.700, yaw=1.571 (90.0°)
  点4: x=4.000, y=0.550, yaw=1.571 (90.0°)
  点5: x=4.000, y=0.400, yaw=1.571 (90.0°)
  点6: x=4.000, y=0.250, yaw=1.571 (90.0°)
  点7: x=4.000, y=0.000, yaw=1.571 (90.0°)

Beta-3参数: orientation=3.14, flag=1 (倒车运动)
容器信息: type=AGV-T300, pos=(5.000, 2.000)
================================================================================
📤 轨迹已发布到 /plans
📋 轨迹ID: complex_backward_XXXXXXXXXX

✅ 所有轨迹发布完成
💡 保持运行以监听MQTT轨迹消息...
   按 Ctrl+C 停止测试
```

---

## 测试其他起点和终点

### 示例1：原点到(1, 1, 0)

**终端2**：
```bash
python3 publish_test_odom.py --x 0 --y 0 --yaw-deg 0
```

**终端4**：
```bash
python3 publish_test_goal.py --x 1 --y 1 --yaw-deg 0
```

### 示例2：(2, 2, 0)到(5, 3, 180)

**终端2**：
```bash
python3 publish_test_odom.py --x 2 --y 2 --yaw-deg 0
```

**终端4**：
```bash
python3 publish_test_goal.py --x 5 --y 3 --yaw-deg 180
```

---

## 验证清单

- [ ] 终端1：MQTT Bridge成功连接
- [ ] 终端2：Odom数据持续发布
- [ ] 终端3：测试节点收到Odom数据
- [ ] 终端3：测试节点收到目标点数据
- [ ] 终端3：自动计算转弯角度和前进距离
- [ ] 终端3：生成前向轨迹（所有路径点已打印）
- [ ] 终端3：前向轨迹成功发布
- [ ] 终端1：MQTT Bridge收到轨迹
- [ ] 终端3：收到MQTT完成信号
- [ ] 终端3：生成后向轨迹（所有路径点已打印）
- [ ] 终端3：后向轨迹成功发布

---

## 故障排查

### 问题1：测试节点一直等待目标点

**原因**：没有发布目标点

**解决**：在终端4运行 `publish_test_goal.py`

### 问题2：测试节点一直等待Odom

**原因**：没有发布Odom数据

**解决**：在终端2运行 `publish_test_odom.py`

### 问题3：只看到前向轨迹路径点，没看到后向轨迹

**原因**：没有收到MQTT完成信号

**解决**：
- 检查MQTT Bridge是否运行
- 或手动按Ctrl+C中断等待（仅测试用）

---

## 快速测试命令汇总

```bash
# 终端1
./start_mqtt_bridge.sh

# 终端2
python3 publish_test_odom.py --x 3.0 --y 0.0 --yaw-deg -90

# 终端3
python3 test_complex_planner_workflow.py

# 终端4（等终端3启动后）
python3 publish_test_goal.py --x 4.0 --y 1.0 --yaw-deg 90
```

---

## 总结

✅ 现在测试代码会：
1. 订阅 `/Odom` 获取起点
2. 订阅 `/nav_goal` 获取目标点
3. 自动计算转弯角度和前进距离
4. 打印所有前向轨迹路径点
5. 打印所有后向轨迹路径点
6. 支持任意起点和终点组合

开始测试吧！🚀
